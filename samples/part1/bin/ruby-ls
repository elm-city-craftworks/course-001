#!/usr/bin/env ruby -s

require 'etc'

switches = "ABCFGHLOPRSTUWabcdefghiklmnopqrstuwx1"
global_variables.grep(/\A\$(?=[a-zA-Z])([^#{switches}])\z/) do
  abort "ls: illegal option -- #{$1}\n" \
        "usage: ls [-#{switches}] [file ...]"
end

files = ARGV
files = ["."] if files.empty?
if dir_given = (files.size == 1 and dir = files[0] and File.directory?(dir))
  Dir.chdir(dir)
  files = $a ? Dir.entries(".") : Dir["*"]
end

if $l
  stats = files.map { |file| File.stat(file) }
  blocks = stats.select(&:file?).map(&:blocks).reduce(0, :+)
  max_size_length = stats.map(&:size).max.to_s.length
  puts "total #{blocks}" if dir_given
  files.zip(stats) { |file,stat|
    entry_type = { "file" => "-", "directory" => "d" }[stat.ftype]
    perms = (%w[r w x] * 3).map.with_index { |p,i|
      stat.mode[8-i] == 1 ? p : '-'
    }.join
    owner = Etc.getpwuid stat.uid
    group = Etc.getgrgid stat.gid
    mtime = stat.mtime.strftime("%b %e %H:%M")
    puts "#{entry_type}#{perms}  #{stat.nlink} #{owner.name}  #{group.name}" \
         "  #{stat.size.to_s.rjust(max_size_length)} #{mtime} #{file}"
  }
else
  files.each do |file|
    if File.exist? file
      puts file
    else
      abort "ls: #{file}: No such file or directory"
    end
  end
end
