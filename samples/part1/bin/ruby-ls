#!/usr/bin/env ruby -s

require 'etc'

switches = "ABCFGHLOPRSTUWabcdefghiklmnopqrstuwx1"
global_variables.grep(/\A\$(?=[a-zA-Z])([^#{switches}])\z/) do
  abort "ls: illegal option -- #{$1}\n" \
        "usage: ls [-#{switches}] [file ...]"
end

files = ARGV
files_given = !files.empty?
files = $a ? Dir.entries(".") : Dir["*"] if files.empty?

if $l
  stats = files.map { |file| File.stat(file) }
  blocks = stats.select(&:file?).map(&:blocks).reduce(0, :+)
  max_size_length = stats.map(&:size).max.to_s.length
  puts "total #{blocks}" unless files_given
  files.zip(stats) { |file,stat|
    entry_type = { "file" => "-", "directory" => "d" }[stat.ftype]
    perms = (stat.mode & 0777).to_s(8).chars.map { |perm|
      perm = Integer(perm)
      [4, 2, 1].zip("rwx".chars).map { |val, name|
        perm & val == 0 ? "-" : name
      }.join
    }.join
    owner = Etc.getpwuid stat.uid
    group = Etc.getgrgid stat.gid
    mtime = stat.mtime.strftime("%b %e %H:%M")
    puts "#{entry_type}#{perms}  #{stat.nlink} #{owner.name}  #{group.name}" \
         "  #{stat.size.to_s.rjust(max_size_length)} #{mtime} #{file}"
  }
else
  files.each do |file|
    if File.exist? file
      puts file
    else
      puts "ls: #{file}: No such file or directory"
    end
  end
end
